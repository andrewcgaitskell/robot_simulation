<!DOCTYPE html>
<html>
<head>
    <title>Bouncing Square Ball (Bounces on Black Squares)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      .chart-container {
        width: 420px;
        height: 420px;
        display: flex;
        justify-content: center;
        align-items: center;
        background: #fafafa;
        margin: 32px auto;
        box-shadow: 0 2px 8px #aaa2;
        border-radius: 10px;
      }
      canvas {
        width: 400px !important;
        height: 400px !important;
        display: block;
      }
    </style>
</head>
<body>
    <h2 style="text-align:center;">Bouncing Ball (Bounces on Black Squares)</h2>
    <div class="chart-container">
      <canvas id="myChart" width="400" height="400"></canvas>
    </div>
    <script>
        const borderSquares = {{ border|tojson }};
        const SQUARE_SIZE = 5;

        // Plugin to draw 5x5 border squares
        const borderSquarePlugin = {
            id: 'borderSquarePlugin',
            beforeDatasetsDraw(chart, args, options) {
                const {ctx, scales: {x, y}} = chart;
                ctx.save();
                ctx.fillStyle = options.color || "#222";
                borderSquares.forEach(cell => {
                    const left = x.getPixelForValue(cell.x);
                    const top = y.getPixelForValue(cell.y + SQUARE_SIZE);
                    const right = x.getPixelForValue(cell.x + SQUARE_SIZE);
                    const bottom = y.getPixelForValue(cell.y);
                    ctx.fillRect(left, top, right - left, bottom - top);
                });
                ctx.restore();
            }
        };

        // Plugin to draw the 5x5 ball as a square
        let ballPos = {x: 50, y: 50};
        const ballSquarePlugin = {
            id: 'ballSquarePlugin',
            afterDatasetsDraw(chart, args, options) {
                const {ctx, scales: {x, y}} = chart;
                ctx.save();
                ctx.fillStyle = options.color || "blue";
                // ballPos is the center, so draw from (center - 2.5, center - 2.5)
                const left = x.getPixelForValue(ballPos.x - 2.5);
                const top = y.getPixelForValue(ballPos.y + 2.5);
                const right = x.getPixelForValue(ballPos.x + 2.5);
                const bottom = y.getPixelForValue(ballPos.y - 2.5);
                ctx.fillRect(left, top, right - left, bottom - top);
                ctx.restore();
            }
        };

        const ctx = document.getElementById('myChart').getContext('2d');
        const data = { datasets: [] };
        const config = {
            type: 'scatter',
            data: data,
            options: {
                animation: false,
                plugins: {
                    legend: { display: false },
                    borderSquarePlugin: { color: "#222" },
                    ballSquarePlugin: { color: "blue" }
                },
                layout: { padding: 0 },
                maintainAspectRatio: true,
                scales: {
                    x: {
                        type: 'linear',
                        min: 0,
                        max: 100,
                        grid: {
                            color: '#888',
                            lineWidth: 2,
                            drawBorder: false
                        },
                        border: { display: false },
                        ticks: { stepSize: 5, display: false },
                        title: { display: false }
                    },
                    y: {
                        type: 'linear',
                        min: 0,
                        max: 100,
                        grid: {
                            color: '#888',
                            lineWidth: 2,
                            drawBorder: false
                        },
                        border: { display: false },
                        ticks: { stepSize: 5, display: false },
                        title: { display: false }
                    }
                }
            },
            plugins: [borderSquarePlugin, ballSquarePlugin]
        };
        const myChart = new Chart(ctx, config);

        let ws = new WebSocket(`ws://${window.location.host}/ws`);
        ws.onmessage = (event) => {
            let msg = JSON.parse(event.data);
            ballPos = {x: msg.x, y: msg.y};
            myChart.update();
        };
    </script>
</body>
</html>
